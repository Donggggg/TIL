# 렉시컬 환경(Lexical Enviroment)

- 자바스크립트에서 `실행 중인 함수, 코드 블록, 스크립트 전체`는 `렉시컬 환경`이라 불리는 `내부 숨김 연관 객체(internal hidden associated object)`를 갖는다.
- 렉시컬 환경 객체는 크게 두 부분으로 구성된다.

```
1. 환경 레코드 (Enviroment Record)
  - 모든 지역 변수를 프로퍼티로 저장하고 있는 객체이다.
  - this 값과 같은 기타 정보도 여기에 해당된다.
2. 외부 렉시컬 환경 (Outer Lexical Enviroment)
  - 외부 코드와 연관된다.
```

### 변수

![](https://i.imgur.com/WB6HGvk.png)

1. 스크립트가 시작되면 선언한 변수 전체가 렉시컬 환경에 올라간다.
   1-1. 이 때, 모든 변수의 상태는 `uninitialized`가 된다.
   1-2. 자바스크립트 엔진은 해당 변수들을 인지하긴 하지만 `let`을 만나기 전에는 사용할 수 없다.
2. `let phrase`를 만나면 phrase가 undefined가 된다.
3. phrase에 값이 할당되고 수정된다.

- 렉시컬 환경은 명세에만 존재하고 실제 객체는 없다.
- 자바스크립트 엔진들은 각자의 방식으로 해당 명세에 맞춰 렉시컬 환경을 최적화한다.

### 함수 선언문

![](https://i.imgur.com/xVeu0wL.png)

- 일반 변수와는 달리 **즉시 초기화**된다.
- 일반 함수를 선언되기도 전에 사용할 수 있는 이유가 이 때문이다.
- 함수 표현식에는 적용되지 않는 이야기이다.

### 내부와 외부 렉시컬 환경

![](https://i.imgur.com/GXoVSiT.png)

- 함수를 호출해 실행하면 렉시컬 환경이 자동으로 새로 만들어진다.
- 이 렉시컬 환경에는 **함수의 인자**와 **내부 변수**가 저장된다.
- 코드에서 변수로 접근할 때 우선 내부 렉시컬 환경에서 변수를 찾는다.
- 내부 환경에서 찾지 못하면 참조하고 있는 외부 환경으로 옮겨 찾는다.
- 이는 전역 렉시컬 환경까지 진행된다.
- 전역 렉시컬 환경까지 찾아도 변수가 없다면 엄격 모드에선 에러가 발생하고 일반 모드에서는 새로운 전역 변수를 생성한다.

### 함수를 반환하는 함수

![](https://i.imgur.com/ISiv0fB.png)

- 모든 함수는 생성된 곳의 렉시컬 환경을 기억한다.
- 함수는 생성된 곳의 렉시컬 환경을 참조하는 `[[Enviroment]]`라는 숨김 프로퍼티를 갖는다.
- 함수가 생성될 때 세팅되고 값이 바뀌지 않는다.

### 가비지 컬렉션

- 함수 호출이 끝나면 대응되는 렉시컬 환경에 대한 참조가 사라지고 메모리에서 제거된다.
- 중첩 함수는 `[[Enviroment]] 숨김 프로퍼티`에 렉시컬 환경을 참조하고 있기에 제거되지 않는다.
